@extends('layouts.app')

@section('content')
    <!-- Customer menu and cart interface -->
    <div class="grid gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2 space-y-4">
            <div class="rounded-lg bg-white p-5 shadow">
                <h2 class="text-lg font-semibold text-gray-800">
                    Meja {{ $table->number }} �- Kode {{ $table->code }}
                </h2>
                <p class="text-sm text-gray-500">
                    Sesi dimulai {{ $session->started_at->format('H:i') }}. Tambahkan menu ke keranjang lalu kirim pesanan.
                </p>
            </div>
            @foreach ($menus as $category => $items)
                <section class="rounded-lg bg-white p-5 shadow">
                    <h3 class="mb-4 text-base font-semibold text-emerald-600">{{ $category }}</h3>
                    <div class="grid gap-4 md:grid-cols-2">
                        @foreach ($items as $menu)
                            <article class="flex flex-col justify-between rounded border border-gray-100 p-4">
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-800">{{ $menu->name }}</h4>
                                    <p class="text-xs text-gray-500">{{ $menu->description }}</p>
                                    <p class="mt-2 text-sm font-bold text-emerald-600">Rp {{ number_format($menu->price, 0, ',', '.') }}</p>
                                    @if ($menu->options->isNotEmpty())
                                        <div class="mt-3 space-y-1 text-xs text-gray-500">
                                            <p class="font-semibold text-gray-600">Opsi:</p>
                                            @foreach ($menu->options as $option)
                                                <p>- {{ $option->name }} ({{ $option->type }}) +Rp {{ number_format($option->extra_price, 0, ',', '.') }}</p>
                                            @endforeach
                                        </div>
                                    @endif
                                </div>
                                <button
                                    data-menu='@json([
                                        'id' => $menu->id,
                                        'name' => $menu->name,
                                        'price' => $menu->price,
                                        'options' => $menu->options->map(fn ($o) => [
                                            'id' => $o->id,
                                            'name' => $o->name,
                                            'extra_price' => $o->extra_price,
                                        ]),
                                    ])'
                                    class="mt-4 inline-flex items-center justify-center rounded bg-emerald-500 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-600">
                                    Tambah
                                </button>
                            </article>
                        @endforeach
                    </div>
                </section>
            @endforeach
        </div>
        <aside class="space-y-4">
            <div class="rounded-lg bg-white p-5 shadow">
                <h3 class="mb-3 text-base font-semibold text-gray-800">Keranjang</h3>
                <div id="cart-empty" class="text-sm text-gray-500">Belum ada item.</div>
                <div id="cart-items" class="hidden space-y-3 text-sm"></div>
                <div class="mt-4 border-t pt-4 text-sm">
                    <p class="flex justify-between">
                        <span>Subtotal</span>
                        <span id="subtotal">Rp 0</span>
                    </p>
                    <p class="flex justify-between text-gray-500">
                        <span>Estimasi Pajak (10%)</span>
                        <span id="tax">Rp 0</span>
                    </p>
                    <p class="flex justify-between text-gray-500">
                        <span>Service (5%)</span>
                        <span id="service">Rp 0</span>
                    </p>
                    <p class="mt-2 flex justify-between text-base font-bold text-emerald-600">
                        <span>Total</span>
                        <span id="grand-total">Rp 0</span>
                    </p>
                </div>
                <form id="order-form" class="mt-4 space-y-3">
                    @csrf
                    <label class="block text-sm font-medium text-gray-700">
                        Catatan
                        <textarea name="notes" class="mt-1 w-full rounded border-gray-200 text-sm focus:border-emerald-500 focus:ring-emerald-500" rows="3" placeholder="Contoh: kurang pedas"></textarea>
                    </label>
                    <label class="block text-sm font-medium text-gray-700">
                        Metode Pembayaran
                        <select name="payment_method" class="mt-1 w-full rounded border-gray-200 text-sm focus:border-emerald-500 focus:ring-emerald-500">
                            <option value="CASH">Bayar di Kasir</option>
                            <option value="QRIS">QRIS</option>
                        </select>
                    </label>
                    <button type="submit" class="inline-flex w-full items-center justify-center rounded bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-40" disabled>
                        Kirim Pesanan
                    </button>
                </form>
                <div id="order-feedback" class="mt-3 text-xs text-gray-500"></div>
            </div>
            <div class="rounded-lg bg-white p-5 shadow">
                <h3 class="mb-3 text-base font-semibold text-gray-800">Status Pesanan</h3>
                <ul id="order-status-list" class="space-y-2 text-sm text-gray-600">
                    <li>Belum ada pesanan.</li>
                </ul>
            </div>
        </aside>
    </div>

    <script>
        const tableCode = @json($table->code);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        const cart = [];
        const rates = { tax: 0.1, service: 0.05 };

        const cartEmpty = document.getElementById('cart-empty');
        const cartItemsContainer = document.getElementById('cart-items');
        const subtotalEl = document.getElementById('subtotal');
        const taxEl = document.getElementById('tax');
        const serviceEl = document.getElementById('service');
        const grandTotalEl = document.getElementById('grand-total');
        const orderForm = document.getElementById('order-form');
        const submitBtn = orderForm.querySelector('button[type="submit"]');
        const feedbackEl = document.getElementById('order-feedback');
        const statusList = document.getElementById('order-status-list');
        const orderStatuses = new Map();

        function formatCurrency(value) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(value);
        }

        function renderCart() {
            if (cart.length === 0) {
                cartEmpty.classList.remove('hidden');
                cartItemsContainer.classList.add('hidden');
                submitBtn.disabled = true;
            } else {
                cartEmpty.classList.add('hidden');
                cartItemsContainer.classList.remove('hidden');
                submitBtn.disabled = false;
            }

            cartItemsContainer.innerHTML = '';

            let subtotal = 0;

            cart.forEach((item, index) => {
                const linePrice = (item.price + item.optionTotal) * item.qty;
                subtotal += linePrice;
                const wrapper = document.createElement('div');
                wrapper.className = 'rounded border border-gray-100 p-3';
                wrapper.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-xs text-gray-500">x${item.qty} �- ${formatCurrency(item.price + item.optionTotal)}</p>
                            ${item.notes ? `<p class="text-xs text-gray-400 mt-1">${item.notes}</p>` : ''}
                        </div>
                        <button data-index="${index}" class="remove-btn text-xs text-red-500 hover:underline">Hapus</button>
                    </div>
                `;
                cartItemsContainer.appendChild(wrapper);
            });

            const tax = subtotal * rates.tax;
            const service = subtotal * rates.service;
            const grand = subtotal + tax + service;

            subtotalEl.textContent = formatCurrency(subtotal);
            taxEl.textContent = formatCurrency(tax);
            serviceEl.textContent = formatCurrency(service);
            grandTotalEl.textContent = formatCurrency(grand);
        }

        document.querySelectorAll('[data-menu]').forEach((button) => {
            button.addEventListener('click', () => {
                const data = JSON.parse(button.dataset.menu);
                const qty = 1;
                cart.push({
                    menu_id: data.id,
                    name: data.name,
                    price: Number(data.price),
                    options: [],
                    optionTotal: 0,
                    qty,
                    notes: '',
                });
                renderCart();
            });
        });

        cartItemsContainer.addEventListener('click', (event) => {
            if (event.target.matches('.remove-btn')) {
                const index = Number(event.target.dataset.index);
                cart.splice(index, 1);
                renderCart();
            }
        });

        orderForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            submitBtn.disabled = true;
            feedbackEl.textContent = 'Mengirim pesanan...';

            const formData = new FormData(orderForm);
            const payload = {
                table_code: tableCode,
                notes: formData.get('notes'),
                items: cart.map((item) => ({
                    menu_id: item.menu_id,
                    qty: item.qty,
                    options: item.options,
                    notes: item.notes,
                })),
                payment: {
                    method: formData.get('payment_method'),
                },
            };

            const response = await fetch('{{ route('order.store') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify(payload),
            });

            if (response.ok) {
                const data = await response.json();
                cart.length = 0;
                renderCart();
                data.order.table_code = tableCode;
                feedbackEl.textContent = data.message;
                appendStatus(data.order);
            } else {
                const error = await response.json().catch(() => ({ message: 'Terjadi kesalahan.' }));
                feedbackEl.textContent = error.message || 'Terjadi kesalahan saat mengirim pesanan.';
            }

            submitBtn.disabled = cart.length === 0;
        });

        function appendStatus(order) {
            if (order.table_code && order.table_code !== tableCode) {
                return;
            }

            if (order.status === 'CLOSED') {
                orderStatuses.delete(order.id);
            } else {
                orderStatuses.set(order.id, order);
            }

            statusList.innerHTML = '';

            if (orderStatuses.size === 0) {
                const emptyState = document.createElement('li');
                emptyState.textContent = 'Belum ada pesanan.';
                statusList.appendChild(emptyState);
                return;
            }

            orderStatuses.forEach((entry) => {
                const item = document.createElement('li');
                item.innerHTML = `<span class="font-semibold">${entry.code}</span> - <span class="uppercase">${entry.status}</span>`;
                statusList.appendChild(item);
            });
        }

        if (window.Echo) {
            window.Echo.channel('orders').listen('.order.updated', (event) => {
                if (event.table_code !== tableCode) {
                    return;
                }
                appendStatus(event);
            });
        }
    </script>
@endsection


